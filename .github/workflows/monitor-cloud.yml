name: Slack Price Monitor (rotating)

on:
  schedule:
    # GitHub Actions cron is UTC. JST = UTC+9
    # 09:00 JST -> 00:00 UTC
    # 15:00 JST -> 06:00 UTC
    # 20:00 JST -> 11:00 UTC
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 11 * * *"
  workflow_dispatch:

jobs:
  run-rotating-monitor:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cloud

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: cloud/package-lock.json

      - name: Install
        run: npm ci

      # JST基準で「今日のジャンル」を決める：hobby -> toys -> games -> hobby -> ...
      - name: Decide profile for today (JST)
        shell: bash
        run: |
          DAY=$(TZ=Asia/Tokyo date +%j)     # 001..365/366
          IDX=$((10#$DAY % 4))             # 0..3

          PROFILE=""
          if [ "$IDX" = "0" ]; then PROFILE="hobby"; fi
          if [ "$IDX" = "1" ]; then PROFILE="toys";  fi
          if [ "$IDX" = "2" ]; then PROFILE="games"; fi
          if [ "$IDX" = "3" ]; then PROFILE="hobby"; fi

          echo "PROFILE=$PROFILE" >> $GITHUB_ENV

          # 1回30件（=各プロファイルlimitを30に上書き）
          echo "PROFILE_LIMIT=30" >> $GITHUB_ENV
          echo "MAX_NOTIFY=30" >> $GITHUB_ENV

          echo "Today(JST day-of-year=$DAY idx=$IDX) -> PROFILE=$PROFILE"

      - name: Run monitor (rotating)
        shell: bash
        run: |
          echo "Running ONLY_PROFILE=$PROFILE"
          ONLY_PROFILE="$PROFILE" npm run monitor
        env:
          KEEPA_API_KEY: ${{ secrets.KEEPA_API_KEY }}
          KEEPA_DOMAIN: ${{ secrets.KEEPA_DOMAIN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          FINDER_PER_PAGE: "100"
          FINDER_MAX_PAGES: "5"
          SLACK_BATCH: "3"
          STRICT_FINDER: "on"
          STRICT_CATEGORY_MATCH: "on"
