name: Slack Price Monitor (rotating)

on:
  schedule:
    # GitHub Actions cron is UTC. JST = UTC+9
    # 09:00 JST -> 00:00 UTC
    # 15:00 JST -> 06:00 UTC
    # 20:00 JST -> 11:00 UTC
    - cron: "0 0 * * *"
    - cron: "0 6 * * *"
    - cron: "0 11 * * *"
  workflow_dispatch:

jobs:
  run-rotating-monitor:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: cloud/package-lock.json

      - name: Install (cloud)
        working-directory: cloud
        run: npm ci

      - name: Decide ONLY_PROFILE for today (JST)
        shell: bash
        run: |
          DAY=$(TZ=Asia/Tokyo date +%j)   # 001..365/366
          IDX=$((10#$DAY % 3))           # 0..2
          if [ "$IDX" = "0" ]; then echo "ONLY_PROFILE=hobby" >> $GITHUB_ENV; fi
          if [ "$IDX" = "1" ]; then echo "ONLY_PROFILE=toys"  >> $GITHUB_ENV; fi
          if [ "$IDX" = "2" ]; then echo "ONLY_PROFILE=games" >> $GITHUB_ENV; fi

          echo "PROFILE_LIMIT=30" >> $GITHUB_ENV
          echo "MAX_NOTIFY=30" >> $GITHUB_ENV

          echo "Today(JST day-of-year=$DAY idx=$IDX) -> ONLY_PROFILE=$ONLY_PROFILE"

      - name: Run monitor (cloud)
        working-directory: cloud
        shell: bash
        run: |
          echo "Running ONLY_PROFILE=$ONLY_PROFILE"
          npm run monitor
        env:
          KEEPA_API_KEY: ${{ secrets.KEEPA_API_KEY }}
          KEEPA_DOMAIN: ${{ secrets.KEEPA_DOMAIN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          ONLY_PROFILE: ${{ env.ONLY_PROFILE }}
          PROFILE_LIMIT: ${{ env.PROFILE_LIMIT }}
          MAX_NOTIFY: ${{ env.MAX_NOTIFY }}

          FINDER_PER_PAGE: "100"
          FINDER_MAX_PAGES: "5"
          SLACK_BATCH: "3"
          STRICT_FINDER: "on"
          STRICT_CATEGORY_MATCH: "on"
