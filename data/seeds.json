// src/jobs/monitor.js
import 'dotenv/config';
import { keepaQuery, keepaProduct } from '../services/keepa.js';
import { fileURLToPath } from 'url';
import { basename } from 'path';

/**
 * ç’°å¢ƒå¤‰æ•°
 */
const {
  KEEPA_API_KEY,
  KEEPA_DOMAIN = '5',
  SLACK_WEBHOOK_URL,

  // Finder / æŠ•ç¨¿ç³»
  FINDER_PER_PAGE = '100',
  FINDER_MAX_PAGES = '3',
  SLACK_BATCH = '10',
  MAX_NOTIFY = '50',

  // è¿½åŠ ã‚¯ã‚¨ãƒª ãƒˆã‚°ãƒ«
  ENABLE_PROFILE_637394 = 'on',
  ENABLE_PROFILE_2277721051 = 'on',

  // Keepa ã‚°ãƒ©ãƒ•
  KEEPA_GRAPH_IMAGE = 'off',
  KEEPA_GRAPH_RANGE = '3', // 1,3,6,12,24 ã®ã‚ˆã†ãªæœŸé–“ãƒ—ãƒªã‚»ãƒƒãƒˆæƒ³å®š
} = process.env;

if (!KEEPA_API_KEY || !SLACK_WEBHOOK_URL) {
  console.error('[monitor] Missing required env: KEEPA_API_KEY or SLACK_WEBHOOK_URL');
  process.exit(1);
}

// æ•°å€¤åŒ–
const PER_PAGE = Number(FINDER_PER_PAGE) || 100;
const MAX_PAGES = Number(FINDER_MAX_PAGES) || 3;
const BATCH = Number(SLACK_BATCH) || 10;
const LIMIT = Number(MAX_NOTIFY) || 50;
const USE_GRAPH = (KEEPA_GRAPH_IMAGE || 'off').toLowerCase() === 'on';

/**
 * Finderã‚¯ã‚¨ãƒª
 * æ—¢å­˜ï¼šãŠã‚‚ã¡ã‚ƒ 13299531 / SALES 1â€“10000 / 7æ—¥é€æ–™è¾¼ -15%ã€œ-1000% / Amazonåœ¨åº«åˆ‡ã‚Œ / NEW>=1000
 * â€»ã‚«ãƒ†ã‚´ãƒªå¼·åˆ¶: categories_include / salesRankReference ã‚’æ•°å€¤IDã§æŒ‡å®š
 */
function buildFinderQuery(page = 0, perPage = PER_PAGE) {
  const ROOT = 13299531;
  return {
    current_SALES_gte: 1,
    current_SALES_lte: 10000,
    rootCategory: [ROOT],
    categories_include: [ROOT],
    salesRankReference: ROOT,
    deltaPercent7_BUY_BOX_SHIPPING_gte: -1000,
    deltaPercent7_BUY_BOX_SHIPPING_lte: -15,
    buyBoxStatsAmazon365_gte: 1,
    buyBoxStatsAmazon365_lte: 100,
    current_AMAZON_gte: -1,
    current_AMAZON_lte: -1,
    current_NEW_gte: 1000,
    sort: [
      ['current_SALES', 'asc'],
      ['monthlySold', 'desc'],
    ],
    productType: [0, 1, 2],
    perPage,
    page,
  };
}

/**
 * è¿½åŠ ã‚¯ã‚¨ãƒªï¼ˆãã®1ï¼‰
 * SALES 1â€“5000 / rootCategory 637394 / Amazonåœ¨åº«åˆ‡ã‚Œ / NEWã®7æ—¥å¤‰åŒ– -15%ã€œ-1000%
 * â€»ã‚«ãƒ†ã‚´ãƒªå¼·åˆ¶
 */
function buildFinderQuery_cat637394(page = 0, perPage = PER_PAGE) {
  const ROOT = 637394;
  return {
    current_SALES_gte: 1,
    current_SALES_lte: 5000,
    current_AMAZON_gte: -1,
    current_AMAZON_lte: -1,
    rootCategory: [ROOT],
    categories_include: [ROOT],
    salesRankReference: ROOT,
    buyBoxStatsAmazon365_gte: 1,
    buyBoxStatsAmazon365_lte: 100,
    deltaPercent7_NEW_gte: -1000,
    deltaPercent7_NEW_lte: -15,
    sort: [
      ['current_SALES', 'asc'],
      ['monthlySold', 'desc'],
    ],
    productType: [0, 1, 2],
    perPage,
    page,
  };
}

/**
 * è¿½åŠ ã‚¯ã‚¨ãƒªï¼ˆãã®2ï¼‰
 * SALES 1â€“10000 / rootCategory 2277721051 / Amazonåœ¨åº«åˆ‡ã‚Œ / NEW>=1000 / NEWã®7æ—¥å¤‰åŒ– -15%ã€œ-1000%
 * â€»ã‚«ãƒ†ã‚´ãƒªå¼·åˆ¶
 */
function buildFinderQuery_cat2277721051(page = 0, perPage = PER_PAGE) {
  const ROOT = 2277721051;
  return {
    current_SALES_gte: 1,
    current_SALES_lte: 10000,
    current_AMAZON_gte: -1,
    current_AMAZON_lte: -1,
    rootCategory: [ROOT],
    categories_include: [ROOT],
    salesRankReference: ROOT,
    buyBoxStatsAmazon365_gte: 1,
    buyBoxStatsAmazon365_lte: 100,
    deltaPercent7_NEW_gte: -1000,
    deltaPercent7_NEW_lte: -15,
    current_NEW_gte: 1000,
    sort: [
      ['current_SALES', 'asc'],
      ['monthlySold', 'desc'],
    ],
    productType: [0, 1, 2],
    perPage,
    page,
  };
}

/**
 * ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é…åˆ—ï¼ˆ[builder, tag, allowedRootCategoryId]ï¼‰
 * è¿½åŠ ã‚¯ã‚¨ãƒªã¯ ENV ã§ON/OFF
 */
const FINDER_PROFILES = [
  [(page) => buildFinderQuery(page), 'ğŸ§¸ Toys(13299531)', 13299531],
  ...(ENABLE_PROFILE_637394.toLowerCase() === 'on'
    ? [[(page) => buildFinderQuery_cat637394(page), 'ğŸ® 637394', 637394]]
    : []),
  ...(ENABLE_PROFILE_2277721051.toLowerCase() === 'on'
    ? [[(page) => buildFinderQuery_cat2277721051(page), 'ğŸ“š 2277721051', 2277721051]]
    : []),
];

/**
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
const yen = (v) =>
  typeof v === 'number' && isFinite(v) ? `Â¥${Math.round(v).toLocaleString('ja-JP')}` : '-';
const pct = (v) =>
  typeof v === 'number' && isFinite(v) ? `${v > 0 ? '+' : ''}${v.toFixed(1)}%` : '-';
const centsToYen = (v) => (typeof v === 'number' && v >= 0 ? v / 100 : null);

function calcPrice7DaysAgo(current, deltaPercent7) {
  if (typeof current !== 'number' || !isFinite(current)) return null;
  if (typeof deltaPercent7 !== 'number' || !isFinite(deltaPercent7)) return null;
  const denom = 1 + deltaPercent7 / 100;
  if (denom === 0) return null;
  return current / denom;
}

const amazonUrl = (asin) => `https://www.amazon.co.jp/dp/${asin}`;
const keepaUrl = (asin, domain = KEEPA_DOMAIN) => `https://keepa.com/#!product/${domain}-${asin}`;

/**
 * Keepa ã‚°ãƒ©ãƒ•ç”»åƒ URLï¼ˆGraph Image APIï¼‰
 */
function buildKeepaGraphImageUrl(
  asin,
  { domainId = Number(KEEPA_DOMAIN) || 5, range = String(KEEPA_GRAPH_RANGE || '3') } = {}
) {
  const params = new URLSearchParams({
    asin,
    domain: String(domainId),
    range,
    salesrank: '1',
    buybox: '1',
    amazon: '1',
    new: '1',
    used: '0',
    width: '1200',
    height: '600',
  });
  return `https://graph.keepa.com/pricehistory.png?${params.toString()}`;
}

/**
 * Slack æŠ•ç¨¿
 */
async function postToSlack(blocks, fallbackText = 'Keepa Monitor Notification') {
  const payload = { text: fallbackText, blocks };
  const res = await fetch(SLACK_WEBHOOK_URL, {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload),
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => '');
    throw new Error(`[monitor] Slack post failed: ${res.status} ${res.statusText} ${txt}`);
  }
}

/**
 * Slack è¡¨ç¤ºæ•´å½¢ï¼šAmazon/Keepaãƒªãƒ³ã‚¯ã€ãƒ©ãƒ³ã‚¯/ç¾åœ¨ä¾¡æ ¼(é€æ–™è¾¼)/7æ—¥å‰ä¾¡æ ¼/7æ—¥å¤‰åŒ–/åœ¨åº«/BuyBox
 */
function productToBlock(p) {
  const asin = p.asin;
  const title = p.title || p.productTitle || '(No title)';
  const stats = p.stats || {};
  const current = stats.current || {};
  const delta7 = stats.deltaPercent7 || {};

  const rank = current.SALES ?? current.SALESr ?? null;

  // é€æ–™è¾¼ã¿å„ªå…ˆ: BUY_BOX_SHIPPING -> BUY_BOX
  const currentWithShipCents = current.BUY_BOX_SHIPPING ?? null;
  const currentWithShip = centsToYen(currentWithShipCents);
  const currentBBOnly = centsToYen(current.BUY_BOX ?? -1);
  const displayCurrent = currentWithShip ?? currentBBOnly;

  // 7æ—¥å¤‰åŒ–ï¼ˆé€æ–™è¾¼ã¿ã«æº–æ‹ ï¼‰
  const delta7Ship =
    typeof delta7.BUY_BOX_SHIPPING === 'number' ? delta7.BUY_BOX_SHIPPING : null;

  // 7æ—¥å‰ä¾¡æ ¼ï¼ˆé€æ–™è¾¼ã¿ã®ãƒ‡ãƒ«ã‚¿ï¼…ã‹ã‚‰é€†ç®—ï¼‰
  const baseForPrev = displayCurrent ?? null;
  const prev7Price =
    baseForPrev != null && delta7Ship != null
      ? calcPrice7DaysAgo(baseForPrev, delta7Ship)
      : null;

  // åœ¨åº«ï¼ˆAmazonåœ¨åº«åˆ‡ã‚Œï¼‰
  const amazonOOS = current.AMAZON === -1;
  const stockLabel = amazonOOS ? 'Amazonåœ¨åº«åˆ‡ã‚Œ' : 'Amazonåœ¨åº«ã‚ã‚Š';

  // BuyBoxã®å‚è€ƒè¡¨ç¤º
  const bbPrice = centsToYen(current.BUY_BOX ?? -1);
  const bbShipIncl = centsToYen(current.BUY_BOX_SHIPPING ?? -1);

  const lines = [];
  lines.push(`*<${amazonUrl(asin)}|Amazon> / <${keepaUrl(asin)}|Keepa>*`);
  lines.push(`*${title}* (ASIN: \`${asin}\`)`);
  lines.push(`â€¢ ãƒ©ãƒ³ã‚¯: ${rank ?? '-'}`);
  lines.push(`â€¢ ç¾åœ¨ä¾¡æ ¼(é€æ–™è¾¼): ${yen(displayCurrent)}`);
  lines.push(`â€¢ 7æ—¥å‰ä¾¡æ ¼: ${yen(prev7Price)}`);
  lines.push(`â€¢ 7æ—¥å¤‰åŒ–: ${pct(delta7Ship ?? NaN)}`);
  lines.push(`â€¢ åœ¨åº«: ${stockLabel}`);
  lines.push(
    `â€¢ BuyBox: ${bbShipIncl != null ? yen(bbShipIncl) : '-'}${
      bbPrice != null ? `ï¼ˆæœ¬ä½“: ${yen(bbPrice)}ï¼‰` : ''
    }`
  );

  return {
    type: 'section',
    text: { type: 'mrkdwn', text: lines.join('\n') },
  };
}

/**
 * Slack 1ãƒãƒƒãƒåˆ†ã®Blocksç”Ÿæˆï¼ˆã‚«ãƒ†ã‚´ãƒªåã‚¿ã‚°ä»˜ãã€ç”»åƒã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 */
function buildBatchBlocks(products, batchIndex = 0) {
  const tagSet = new Set(products.map((p) => p.__tag || ''));
  const tagLabel = tagSet.size === 1 ? [...tagSet][0] : 'ğŸ§© Mixed';

  const header = {
    type: 'header',
    text: {
      type: 'plain_text',
      text: `Keepa Monitor ${tagLabel} - Batch ${batchIndex + 1}`,
      emoji: true,
    },
  };
  const divider = { type: 'divider' };
  const blocks = [header, divider];

  for (const p of products) {
    blocks.push(productToBlock(p));

    if (USE_GRAPH) {
      const imgUrl = buildKeepaGraphImageUrl(p.asin);
      blocks.push({
        type: 'image',
        image_url: imgUrl,
        alt_text: `Keepa Graph ${p.asin}`,
      });
    }
    blocks.push(divider);
  }
  if (blocks[blocks.length - 1] === divider) blocks.pop();
  return blocks;
}

/**
 * /query â†’ ASINåé›†ï¼ˆå…¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ¨ªæ–­, ã‚¿ã‚°ä¿æŒï¼‰
 * keepaQuery ã¯ã€Œ{ selection: ... }ã€ã‚’ POST ãƒœãƒ‡ã‚£ã«å—ã‘å–ã‚‹å®Ÿè£…
 */
async function collectAsins() {
  const items = []; // { asin, tag }
  const seen = new Set();

  for (const [build, tag] of FINDER_PROFILES) {
    for (let page = 0; page < MAX_PAGES; page++) {
      const body = build(page);
      const res = await keepaQuery({ selection: body });

      const pageAsins =
        res?.asinList ??
        res?.results?.asinList ??
        res?.products?.map((x) => x.asin) ??
        [];

      for (const asin of pageAsins) {
        if (!asin || seen.has(asin)) continue;
        seen.add(asin);
        items.push({ asin, tag });
        if (items.length >= LIMIT) break;
      }
      if (items.length >= LIMIT || pageAsins.length === 0) break;
    }
    if (items.length >= LIMIT) break;
  }

  return items.slice(0, LIMIT); // [{ asin, tag }]
}

/**
 * /product â†’ è©³ç´°å–å¾—ï¼ˆ100ä»¶ãƒãƒ£ãƒ³ã‚¯ã€ã‚¿ã‚°å¾©å…ƒ & æœ€çµ‚ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ï¼‰
 * keepaProduct(asins) ã¯ products ã‚’è¿”ã™å®Ÿè£…ï¼ˆstats=180 ã¯ keepa.js å´ï¼‰
 */
async function fetchProducts(asinWithTags) {
  const chunkSize = 100;
  const products = [];
  for (let i = 0; i < asinWithTags.length; i += chunkSize) {
    const chunk = asinWithTags.slice(i, i + chunkSize);
    const asins = chunk.map((x) => x.asin);
    const list = await keepaProduct(asins); // keepa.js ãŒ stats=180 ã‚’ä»˜ä¸
    for (const p of list) {
      if (!p?.asin) continue;

      // ã‚¿ã‚°å¾©å…ƒ
      const tagged = chunk.find((x) => x.asin === p.asin);
      const tag = tagged?.tag || '';

      // âœ… æœ€çµ‚ãƒ•ã‚£ãƒ«ã‚¿ï¼šæƒ³å®šrootã‚«ãƒ†ã‚´ãƒªã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã®ã¿æ¡ç”¨
      const allowedRoot = FINDER_PROFILES.find((fp) => fp[1] === tag)?.[2]; // 3ç•ªç›®ãŒallowed root
      if (typeof allowedRoot === 'number' && p.rootCategory !== allowedRoot) continue;

      products.push({ ...p, __tag: tag });
    }
  }
  return products;
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
export async function runMonitor() {
  console.log('[monitor] start');

  const asinWithTags = await collectAsins();
  if (!asinWithTags.length) {
    console.log('[monitor] no ASINs found by /query conditions');
    return;
  }
  console.log(`[monitor] collected ASINs: ${asinWithTags.length}`);

  const products = await fetchProducts(asinWithTags);
  console.log(`[monitor] fetched products: ${products.length}`);

  if (!products.length) {
    console.log('[monitor] no product details fetched');
    return;
  }

  // ãƒãƒƒãƒåˆ†å‰²ã—ã¦SlackæŠ•ç¨¿
  for (let i = 0; i < products.length; i += BATCH) {
    const slice = products.slice(i, i + BATCH);
    const blocks = buildBatchBlocks(slice, i / BATCH);
    await postToSlack(blocks, `Keepa Monitor - ${slice.length} items`);
    console.log(`[monitor] posted batch ${Math.floor(i / BATCH) + 1}`);
  }

  console.log('[monitor] done');
}

/**
 * ç›´æ¥å®Ÿè¡Œ
 */
const isDirect = (() => {
  try {
    const invoked = process.argv[1] && basename(process.argv[1]);
    const self = basename(fileURLToPath(import.meta.url));
    return invoked === self;
  } catch {
    return false;
  }
})();

if (isDirect) {
  runMonitor().catch((err) => {
    console.error('[monitor] fatal:', err);
    process.exit(1);
  });
}
